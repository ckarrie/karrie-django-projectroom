{% extends 'projectroom/base.html' %}
{% load mptt_tags %}

{% block breadcrumbs %}
{% endblock %}


{% block js %}
<style type="text/css">
    #ticketitems {
        float: left;
        width: 50em;
    }

    #sidebar {
        float: right;
        width: 20em;
        background:#eee;
        padding: 1em;
        margin: 1em;
        border: 1px solid #aaa;

    }

</style>
{% endblock js %}

{% block content %}

    <h2>Dashboard</h2>

    <div id="ticketitems">
        <h3>Neuste Änderungen</h3>
        {% for item in latest_ticketitems %}
            <div class="ticketitem">
                <p class="ticketitemmeta">Vor {{ item.created|timesince }} von {{ item.creator }} in <br />
                    <a href="{{ item.ticket.job.project.get_absolute_url }}">{{ item.ticket.job.project }}</a> /

                    {% for job in item.ticket.job.get_path %}
                        <a href="{{ job.get_absolute_url }}">{{ job }}</a>
                        {% if not forloop.last %}
                            &raquo;
                        {% endif %}
                    {% endfor %}
                </p>
                <p><a href="{{ item.ticket.get_absolute_url }}">Ticket #{{ item.ticket.pk }}: {{ item.ticket }}</a></p>

                {% if item.tickettext_set.exists %}
                    <blockquote>Änderung:
                        <q>{{ item.tickettext_set.all.0.text|truncatewords:8 }}</q>
                    </blockquote>
                {% endif %}

                {% if item.ticketstatuschange_set.exists %}
                    <blockquote>Status auf <q>{{ item.ticketstatuschange_set.all.0.get_post_status_display }}</q></blockquote>
                {% endif %}

                {% if item.ticketaccountentry_set.exists %}
                    <blockquote>
                        <p>
                        Abbuchung von {{ item.ticketaccountentry_set.all.0.accountentry.value }} {{ item.ticketaccountentry_set.all.0.accountentry.get_currency_display }}
                        von Konto {{ item.ticketaccountentry_set.all.0.accountentry.account }} erfolgt
                        </p>
                    </blockquote>
                {% endif %}
            </div>

        {% empty %}
            <p>Es existiert keine Ticketbeschreibung</p>
        {% endfor %}

    </div>

    <div id="sidebar" class="border-radius">
        <h3>Meine Projekte</h3>
        <ul>
        {% for project in my_projects %}
            <li><a href="{% url 'job_list' project__slug=project.slug %}">{{ project }}</a> <span class="small">({{ project.client_company }})</span></li>
        {% endfor %}
        </ul>
        <p><a href="{% url 'project_list' %}" class="btn">Übersicht</a></p>
    </div>

    <div style="clear: both;"></div>


{% endblock %}